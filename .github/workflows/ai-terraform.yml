name: AI Terraform Automation

on:
  push:
    branches:
      - test-api-gpt4o
    paths:
      - 'main.ps1'
      - '.github/workflows/ai-terraform.yml'
      - 'main.tf'

  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe the VM setup (e.g., Create Ubuntu VM in EastUS named NextOpsLVM07)"
        required: true
        default: "Create Ubuntu VM in EastUS named NextOpsLVM07"

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # üßæ Step 1 ‚Äî Checkout repository (use PAT to allow push triggers)
    - name: Checkout Repo
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.PAT_TOKEN }}

    # ‚öôÔ∏è Step 2 ‚Äî Setup Terraform
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3

    # ‚ö° Step 3 ‚Äî Azure Login
    - name: Azure Login for Deployment
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        enable-AzPSSession: true

    # ü§ñ Step 4 ‚Äî Deploy GPT-4o Model
    - name: Deploy GPT-4o Model
      shell: bash
      run: |
        echo "üöÄ Deploying GPT-4o model to Azure OpenAI..."
        az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
        az cognitiveservices account deployment create \
          --resource-group RG \
          --name tty \
          --deployment-name gpt4o-deploy \
          --model-name gpt-4o \
          --model-version "2024-11-20" \
          --model-format OpenAI \
          --sku-capacity 1 \
          --sku-name "Standard"
        echo "‚úÖ GPT-4o model deployment step completed."

    # üß† Step 5 ‚Äî Run PowerShell + AI + Terraform Automation
    - name: Run PowerShell + AI + Terraform
      env:
        AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
        AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
        ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
        ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
        ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
        ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
      run: pwsh ./main.ps1 -Prompt "${{ github.event.inputs.prompt || 'Create Ubuntu VM in EastUS named NextOpsLVM07' }}"

    # ü™Ñ Step 6 ‚Äî Terraform Init
    - name: Terraform Init
      run: terraform init

    # ü™Ñ Step 7 ‚Äî Terraform Apply
    - name: Terraform Apply
      run: terraform apply -auto-approve
