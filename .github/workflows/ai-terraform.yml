name: AI Terraform Automation

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe what you want to create (e.g., Create Ubuntu VM in EastUS named NextOpsLVM07)"
        required: true

  push:
    branches:
      - test-api-gpt4o
    paths:
      - 'main.ps1'
      - '.github/workflows/ai-terraform.yml'
      - 'main.tf'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # üßæ Step 1 ‚Äî Checkout repository
      - name: Checkout Repo
        uses: actions/checkout@v4

      # ‚öôÔ∏è Step 2 ‚Äî Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ‚ö° Step 3 ‚Äî Azure Login
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}"
            }

      # ü§ñ Step 4 ‚Äî Deploy GPT-4o Model (if not already deployed)
      - name: Deploy GPT-4o Model
        shell: bash
        run: |
          echo "üöÄ Deploying GPT-4o model to Azure OpenAI..."
          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
          az cognitiveservices account deployment create \
            --resource-group RG \
            --name tty \
            --deployment-name gpt4o-deploy \
            --model-name gpt-4o \
            --model-version "2024-11-20" \
            --model-format OpenAI \
            --sku-capacity 1 \
            --sku-name "Standard" || echo "‚úÖ Deployment may already exist, skipping..."
          echo "‚úÖ GPT-4o model deployment step completed."

      # üß† Step 5 ‚Äî Run PowerShell + AI + Terraform Automation
      - name: Run PowerShell + AI + Terraform
        shell: pwsh
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        run: |
          $Prompt = "${{ github.event.inputs.prompt }}"
          if (-not $Prompt) {
            Write-Host "‚ùå No prompt provided. Please run manually and enter a prompt."
            exit 1
          }
          Write-Host "üí° Using user-provided prompt: $Prompt"
          pwsh ./main.ps1 -Prompt "$Prompt"
