name: AI Terraform Automationn

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: "Describe the VM setup (e.g., Create Ubuntu VM in EastUS named NextOpsLVM07)"
        required: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # üßæ Step 1 ‚Äî Checkout repository
      - name: Checkout Repo
        uses: actions/checkout@v4

      # ‚öôÔ∏è Step 2 ‚Äî Setup Terraform
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      # ‚ö° Step 3 ‚Äî Azure Login (needed for model deployment)
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: |
            {
              "clientId": "${{ secrets.ARM_CLIENT_ID }}",
              "clientSecret": "${{ secrets.ARM_CLIENT_SECRET }}",
              "tenantId": "${{ secrets.ARM_TENANT_ID }}",
              "subscriptionId": "${{ secrets.ARM_SUBSCRIPTION_ID }}"
            }

      # ü§ñ Step 4 ‚Äî Deploy GPT-4o Model
      - name: Deploy GPT-4o Model
        shell: bash
        run: |
          echo "üöÄ Deploying GPT-4o model to Azure OpenAI..."
          az account set --subscription "${{ secrets.ARM_SUBSCRIPTION_ID }}"
          az cognitiveservices account deployment create \
            --resource-group RG \
            --name tty \
            --deployment-name gpt4o-deploy \
            --model-name gpt-4o \
            --model-version "2024-11-20" \
            --model-format OpenAI \
            --sku-capacity 1 \
            --sku-name "Standard"
          echo "‚úÖ GPT-4o model deployment step completed."

      # üß† Step 5 ‚Äî Setup PowerShell
 
      - name: Setup PowerShell
        uses: actions/setup-powershell@v2

      # üîß Step 6 ‚Äî Run PowerShell + AI + Terraform Automation
      - name: Run PowerShell + AI + Terraform
        env:
          AZURE_OPENAI_ENDPOINT: ${{ secrets.AZURE_OPENAI_ENDPOINT }}
          AZURE_OPENAI_KEY: ${{ secrets.AZURE_OPENAI_KEY }}
          ARM_CLIENT_ID: ${{ secrets.ARM_CLIENT_ID }}
          ARM_CLIENT_SECRET: ${{ secrets.ARM_CLIENT_SECRET }}
          ARM_TENANT_ID: ${{ secrets.ARM_TENANT_ID }}
          ARM_SUBSCRIPTION_ID: ${{ secrets.ARM_SUBSCRIPTION_ID }}
        run: pwsh ./main.ps1 -Prompt "${{ github.event.inputs.prompt }}"
